<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>tracking.js - color with camera</title>
  <link rel="stylesheet" href="assets/demo.css">
  <script src="../build/tracking-min.js"></script>
  <style>
  video, canvas {
    margin-left: 100px;
    margin-top: 35px;
    position: absolute;
  }
  </style>
</head>
<body>
  <div style="min-height:50px;">
    <h4>Video Stream:</h4>
  </div>
  <div style="min-height: 500px;">
    <video id="camera" width="600" height="450"></video>
    <canvas id="snap" width="600" height="450"></canvas>
  </div>
  <div style="min-height:50px;">
    <input id="button" type="button" value="Take Snapshot" />
    <h4>Stored Original Content:</h4>
  </div>
  <div style="min-height: 500px;">
    <canvas id="original" width="600" height="450"></canvas>
  </div>
  <div style="min-height:50px;">
    <h4>New Snapshot:</h4>
  </div>
  <div style="min-height: 500px;">
    <canvas id="new" width="600" height="450"></canvas>
  </div>
  <div style="min-height:50px;">
    <h4>Difference:</h4>
  </div>
  <div style="min-height:500px;">
    <canvas id="diff" width="600" height="450"></canvas>
  </div>

  <script>
    navigator.getUserMedia({video: true, audio: false}, function(stream){
      var video = document.getElementById('camera');
      var canvas = document.getElementById('snap');
      var ctx = canvas.getContext('2d');
      var button = document.getElementById('button');

      var oCanvas = document.getElementById('original');
      var oCtx = oCanvas.getContext('2d');
      var imgData = oCtx.getImageData(0,0,600,450);
      var oCtxLen = imgData.data.length;

      var nCanvas = document.getElementById('new');
      var nCtx = nCanvas.getContext('2d');
      var nImgData = nCtx.getImageData(0,0,600,450);
      var nCtxLen = nImgData.data.length;

      var dCanvas = document.getElementById('diff');
      var dCtx = dCanvas.getContext('2d');
      var dImgData = dCtx.getImageData(0,0,600,450);
      var dCtxLen = dImgData.data.length;

      var captured = [];
      var oCaptured = [];
      for(var i = 0; i < canvas.width * canvas.height; i++) {
        captured.push(0);
      }

      tracking.ColorTracker.registerColor('green', function(r, g, b) {
        if(r > 50 && r < 143 && g > 120 && g < 170 && b > 110 && b < 150) {
          return true;
        } else {
          return false;
        }
      });

      var tracker = new tracking.ColorTracker(['green']);
      tracker.setMinGroupSize(1);
      tracking.track('#camera', tracker, {});
      tracker.on('track', function(event) {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        captured = [];
        for(var i = 0; i < canvas.width * canvas.height; i++) {
          captured.push(0);
        }

        if(event.data.length == 0) {
          console.log('nothing found');
        } else {
          event.data.forEach(function(rect) {
            ctx.strokeStyle = rect.color;
            ctx.strokeRect(rect.x, rect.y, rect.width, rect.height);
            ctx.font = '11px Helvetica';
            ctx.fillStyle = "#fff";
            ctx.fillText('x: ' + rect.x + 'px', rect.x + rect.width + 5, rect.y + 11);
            ctx.fillText('y: ' + rect.y + 'px', rect.x + rect.width + 5, rect.y + 22);
            for(var i = 0; i < rect.height; i++) {
              for(var j = 0; j < rect.width; j++) {
                captured[canvas.width * (rect.y + i) + rect.x + j] = 1;
              }
            }
          });
        }
      });

      button.onclick = function() {
        nCtx.putImageData(imgData,0,0);

        for(var i = 0; i < oCtxLen / 4; i++) {
          if(captured[i]) {
            imgData.data[4*i] = 0;
            imgData.data[4*i+1] = 0;
            imgData.data[4*i+2] = 0;
          } else {
            imgData.data[4*i] = 255;
            imgData.data[4*i+1] = 255;
            imgData.data[4*i+2] = 255;
          }
          imgData.data[4*i+3] = 255;
        }

        //difference
        dCaptured = [];
        for(var i = 0; i < captured.length; i++) {
          dCaptured[i] = captured[i] - oCaptured[i];
        }
        for(var i = 0; i < dCtxLen / 4; i++) {
          if(dCaptured[i]) {
            dImgData.data[4*i] = 0;
            dImgData.data[4*i+1] = 0;
            dImgData.data[4*i+2] = 0;
          } else {
            dImgData.data[4*i] = 255;
            dImgData.data[4*i+1] = 255;
            dImgData.data[4*i+2] = 255;
          }
          dImgData.data[4*i+3] = 255;
        }
        dCtx.putImageData(dImgData,0,0);

        oCaptured = captured;
        oCtx.putImageData(imgData,0,0);
      }
      video.src = URL.createObjectURL(stream);
      video.play();
      ctx.drawImage(video, 0, 0, 600, 450);
    }, function(err) {
      console.log(err);
    });
  </script>

</body>
</html>
